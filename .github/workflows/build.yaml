name: Build and test
on:
  pull_request:
  push:
    paths-ignore:
      - '**.md'
      - 'LICENSE'

jobs:
  build:
    name: Build
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]
        type: [release]
    runs-on: ${{ matrix.os }}
    env:
      CI_MODEL_ID: deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B
      CI_MODEL_DIR: ${{ github.workspace }}/.ci-model
      HF_HOME: ${{ github.workspace }}/.hf-cache
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
    steps:

    - name: checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: install xmake
      uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest
    
    - name: Xmake Build & Install
      run: | 
        xmake
        xmake install
    
    - name: Install Python
      run: | 
        python -m pip install --upgrade pip
        cd python
        pip install .
        cd ..
        pip install pytest huggingface_hub

    - name: Run core/offline/engine/online (no model) tests
      shell: bash
      run: |
        python -m pytest -q \
          test/core/test_core_model_api.py \
          test/core/test_core_output_api.py \
          test/core/test_core_decode_batch.py \
          test/core/test_kv_cache.py \
          test/core/test_model_registry.py \
          test/core/test_qwen2_adapter.py \
          test/offline/test_offline.py \
          test/offline/test_llm_entrypoint.py \
          test/engine/test_engine_model_registry.py \
          test/engine/test_engine_state_machine.py \
          test/engine/test_sampling.py \
          test/online/test_online.py \
          test/online/test_online_http.py \
          test/online/test_online_stream_isolation.py \
          --device cpu --layout block --backend native

    - name: Cache HF model
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.CI_MODEL_DIR }}
          ${{ env.HF_HOME }}
        key: hf-${{ runner.os }}-deepseek-r1-distill-qwen-1_5b-v1

    - name: Download real model for CI
      shell: bash
      run: |
        python - <<'PY'
        import os
        from huggingface_hub import snapshot_download

        repo_id = os.environ["CI_MODEL_ID"]
        local_dir = os.environ["CI_MODEL_DIR"]
        os.makedirs(local_dir, exist_ok=True)
        snapshot_download(
            repo_id=repo_id,
            local_dir=local_dir,
            local_dir_use_symlinks=False,
            token=os.environ.get("HF_TOKEN") or None,
        )
        print(f"model ready: {local_dir}")
        PY

    - name: Run test_infer smoke (CPU block)
      shell: bash
      run: |
        python -m pytest -q test/parity/test_infer.py -k smoke --model-path "$CI_MODEL_DIR" --device cpu --layout block --backend native

    - name: Run test_infer smoke (CPU slot)
      shell: bash
      run: |
        python -m pytest -q test/parity/test_infer.py -k smoke --model-path "$CI_MODEL_DIR" --device cpu --layout slot --backend native

    - name: Run parity tests (CPU block + slot)
      shell: bash
      run: |
        python -m pytest -q test/parity/test_core_parity.py test/parity/test_offline_parity.py --model-path "$CI_MODEL_DIR" --device cpu --layout all --backend native

    - name: Run real-model online multisession tests
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        python -m pytest -q test/online/test_online_real_model_multisession.py --model-path "$CI_MODEL_DIR"
